<source>
  @type tail
  @id in_tail_container_logs
  path /var/log/containers/*default_app-*.log, /var/log/containers/*default_init-*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag "kubernetes.*"
  read_from_head true
  <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

<filter kubernetes.**>
  @type kubernetes_metadata
  @id filter_kube_metadata
  skip_container_metadata true
  skip_namespace_metadata true
  skip_master_url true
  tag_to_kubernetes_name_regexp ".+?\\.containers\\.(?<pod_name>[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*)_(?<namespace>[^_]+)_(?<container_name>.+)-(?<docker_id>[a-z0-9]{64})\\.log$"
</filter>

<match kubernetes.**>
  @type rewrite_tag_filter
  <rule>
    key     $.kubernetes.container_name
    pattern /^app$/
    tag     pod.app
  </rule>
  <rule>
    key     $.kubernetes.container_name
    pattern /^init$/
    tag     pod.init
  </rule>
</match>

<match pod.app>
  @type rewrite_tag_filter
  <rule>
    key     log
    pattern /^\[\w{3} \w{3} \d{2} \d{2}:\d{2}:\d{2} UTC \d{4}\] \[openpai-runtime\].*$/
    tag     app.runtime
  </rule>
  <rule>
    key     log
    pattern /.+/
    tag     app.user
  </rule>
</match>

# <match app.user>
#   @type copy
#   <store>
#     @type file
#     path                            "/var/log/fluent/job-${$.docker.container_id}.all" # tag[3] for the pod uid
#     # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
#     # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
#     <format>
#       @type single_value
#       message_key log
#       add_newline false
#     </format>
#     <buffer $.docker.container_id>
#         @type file
#         path /var/log/fluent/azurestorageappendblob-all
#         timekey 60 # 1 minute
#         timekey_wait 60
#         timekey_use_utc true # use utc
#         chunk_limit_size 10m
#     </buffer>
#   </store>
#   <store>
#     @type file
#     path                            "/var/log/fluent/job-${$.docker.container_id}.${stream}" # tag[3] for the pod uid
#     <format>
#       @type single_value
#       message_key log
#       add_newline false
#     </format>
#     # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
#     # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
#     <buffer $.docker.container_id, stream>
#         @type file
#         path /var/log/fluent/azurestorageappendblob-std
#         timekey 60 # 1 minute
#         timekey_wait 60
#         timekey_use_utc true # use utc
#         chunk_limit_size 10m
#     </buffer>
#   </store>
# </match>
#
# <match pod.init>
#   @type file
#   path                            "/var/log/fluent/init-${$.docker.container_id}.log"
#   <format>
#     @type single_value
#     message_key log
#     add_newline false
#   </format>
#   # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
#   # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
#   <buffer $.docker.container_id>
#       @type file
#       path /var/log/fluent/azurestorageappendblob-init
#       chunk_limit_size 10m
#   </buffer>
# </match>
#
# <match app.runtime>
#   @type file
#   path                            "/var/log/fluent/runtime-${$.docker.container_id}.log"
#   <format>
#     @type single_value
#     message_key log
#     add_newline false
#   </format>
#   # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
#   # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
#   <buffer $.docker.container_id>
#       @type file
#       path /var/log/fluent/azurestorageappendblob-runtime
#       chunk_limit_size 10m
#   </buffer>
# </match>

<match app.user>
  @type copy
  <store>
    @type azure-storage-append-blob
    @id out_azure_user_all_log

    azure_storage_account           "#{ENV['AZUREBLOB_ACCOUNT_NAME']}"
    azure_storage_access_key        "#{ENV['AZUREBLOB_ACCOUNT_KEY']}"
    azure_container                 "#{ENV['AZUREBLOB_CONTAINER']}"
    auto_create_container           true
    path                            "/var/log/fluent/job-${$.docker.container_id}.all"
    azure_object_key_format         %{path}.%{index}
    # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
    # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
    <format>
      @type single_value
      message_key log
      add_newline false
    </format>
    <buffer $.docker.container_id>
        @type file
        path /var/log/fluent/azurestorageappendblob-all
        chunk_limit_size 10m
    </buffer>
  </store>
  <store>
    @type azure-storage-append-blob
    @id out_azure_user_std_log

    azure_storage_account           "#{ENV['AZUREBLOB_ACCOUNT_NAME']}"
    azure_storage_access_key        "#{ENV['AZUREBLOB_ACCOUNT_KEY']}"
    azure_container                 "#{ENV['AZUREBLOB_CONTAINER']}"
    auto_create_container           true
    path                            "/var/log/fluent/job-${$.docker.container_id}.${stream}"
    azure_object_key_format         %{path}.%{index}
    <format>
      @type single_value
      message_key log
      add_newline false
    </format>
    # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
    # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
    <buffer $.docker.container_id, stream>
        @type file
        path /var/log/fluent/azurestorageappendblob-std
        chunk_limit_size 10m
    </buffer>
  </store>
</match>

<match pod.init>
  @type file
  @id out_azure_init_log
  path                            "/var/log/fluent/init-${$.docker.container_id}.log"

  azure_storage_account           "#{ENV['AZUREBLOB_ACCOUNT_NAME']}"
  azure_storage_access_key        "#{ENV['AZUREBLOB_ACCOUNT_KEY']}"
  azure_container                 "#{ENV['AZUREBLOB_CONTAINER']}"
  azure_object_key_format         %{path}_%{index}.log
  auto_create_container           true
  <format>
    @type single_value
    message_key log
    add_newline false
  </format>
  # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
  # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
  <buffer $.docker.container_id>
      @type file
      path /var/log/fluent/azurestorageappendblob-init
      chunk_limit_size 10m
  </buffer>
</match>

<match app.runtime>
  @type file
  @id out_azure_runtime_log
  path                            "/var/log/fluent/runtime-${$.docker.container_id}.log"

  azure_storage_account           "#{ENV['AZUREBLOB_ACCOUNT_NAME']}"
  azure_storage_access_key        "#{ENV['AZUREBLOB_ACCOUNT_KEY']}"
  azure_container                 "#{ENV['AZUREBLOB_CONTAINER']}"
  azure_object_key_format         %{path}_%{index}.log
  auto_create_container           true
  <format>
    @type single_value
    message_key log
    add_newline false
  </format>
  # if you want to use %{tag} or %Y/%m/%d/ like syntax in path / azure_blob_name_format,
  # need to specify tag for %{tag} and time for %Y/%m/%d in <buffer> argument.
  <buffer $.docker.container_id>
      @type file
      path /var/log/fluent/azurestorageappendblob-runtime
      chunk_limit_size 10m
  </buffer>
</match>
